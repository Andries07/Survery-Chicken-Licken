<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chicken Licken Feedback v2</title>
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --card-rgba: rgba(255,255,255,0.78);
    --field-rgba: rgba(255,255,255,0.9);
    --text:#111;
    --cl:#ff6900; --green:#16a34a; --green2:#22c55e; --yellow:#facc15; --orange:#fb923c; --red:#dc2626;
  }
  html,body{margin:0;height:100%;font-family:Arial,sans-serif;background:#000}
  .hero{
    min-height:100dvh;
    background-image:url('./background.jpg');
    background-repeat:repeat;
    background-size:160px auto;
    background-position:top left;
    display:grid;place-items:start center;
    padding:14px 2vw 24px;
  }
  .wrap{width:min(860px,96vw);background:transparent}
  h1{margin:0 0 10px;text-align:center;color:#fff;font-weight:900;text-shadow:0 2px 8px rgba(0,0,0,.55)}
  .grid{display:grid;gap:10px}
  .card{background:var(--card-rgba);border-radius:14px;padding:12px;box-shadow:0 10px 24px rgba(0,0,0,.22);backdrop-filter:saturate(120%) blur(2px)}
  .q-title{font-weight:800;margin-bottom:8px;color:var(--text)}
  .q-row{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .opt{display:grid;place-items:center;gap:4px;padding:10px;min-height:64px;border-radius:12px;color:#fff;font-weight:800;cursor:pointer;border:2px solid transparent;user-select:none}
  .opt.active{outline:3px solid #000}
  .opt[data-score="5"]{background:var(--green)}
  .opt[data-score="4"]{background:var(--green2)}
  .opt[data-score="3"]{background:var(--yellow);color:#111}
  .opt[data-score="2"]{background:var(--orange)}
  .opt[data-score="1"]{background:var(--red)}
  .emo{font-size:22px}
  .lbl{font-size:13px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:640px){.grid2{grid-template-columns:1fr}}
  input,textarea{width:100%;padding:10px;border:1.4px solid #ddd;border-radius:10px;font-size:15px;min-width:0;background:var(--field-rgba)}
  textarea{min-height:64px;resize:vertical}
  .row-end{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-top:6px}
  .btn{background:#000;color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:900;font-size:17px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.25)}
  .btn:hover{filter:brightness(0.92)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:#ffffff;opacity:.9;font-size:13px;min-height:18px;text-shadow:0 1px 3px rgba(0,0,0,.6)}
  .thanks{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);place-items:center;z-index:20}
  .thanks .in{background:#fff;padding:22px;border-radius:16px;text-align:center;width:min(420px,92vw);box-shadow:0 18px 54px rgba(0,0,0,.4)}
  .error{outline:2px solid #dc2626}
</style>
</head>
<body>
  <!-- Unregister any old service worker & clear caches to avoid stale builds -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
    }
    if ('caches' in window) {
      caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
    }
  </script>

  <div class="hero">
    <div class="wrap">
      <h1>Chicken Licken Quick Feedback</h1>

      <!-- Questions -->
      <div id="qList" class="grid"></div>
      <div style="height:10px"></div>

      <!-- Optional details -->
      <div class="card">
        <h3 style="margin:0 0 6px;color:#111">Optional details</h3>
        <div style="font-size:12px;color:#444;margin-top:4px">
          If you share any details below, <b>Name</b>, <b>Surname</b> and a <b>10-digit Phone</b> are required and you must accept POPIA.
        </div>

        <div class="grid2" style="margin-top:8px">
          <div><input id="name" placeholder="Name (required if details provided)" autocomplete="off"></div>
          <div><input id="surname" placeholder="Surname (required if details provided)" autocomplete="off"></div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div><input id="phone" placeholder="Phone (10 digits, required if details provided)" maxlength="10" autocomplete="off"></div>
          <div><input id="email" placeholder="Email (optional)" autocomplete="off"></div>
        </div>
        <div style="margin-top:8px">
          <textarea id="feedback" placeholder="Additional feedback (optional)" autocomplete="off"></textarea>
        </div>

        <!-- POPIA consent (required if personal details provided) -->
        <label style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:start;margin-top:8px">
          <input type="checkbox" id="popia" style="margin-top:4px">
          <small>
            I consent to the collection and processing of my personal information for customer service and quality feedback purposes
            in accordance with the Protection of Personal Information Act, 2013 (POPIA).
          </small>
        </label>

        <!-- Marketing consent (optional opt-in) -->
        <label style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:start;margin-top:6px">
          <input type="checkbox" id="mk" style="margin-top:4px">
          <small>
            I agree to receive marketing communications, promotions, special offers and related content from Chicken Licken via the contact details I provide.
            I understand I can withdraw my consent at any time.
          </small>
        </label>
      </div>

      <!-- Footer -->
      <div class="row-end">
        <div class="muted" id="storeTag"></div>
        <div class="muted" id="statusTxt"></div>
        <button class="btn" id="submitBtn" disabled>Submit</button>
      </div>
    </div>
  </div>

  <!-- Thank-you -->
  <div class="thanks" id="thanks">
    <div class="in">
      <h2>Thank you!</h2>
      <p>Your feedback has been recorded.</p>
      <button class="btn" id="againBtn">Done</button>
    </div>
  </div>

<script>
/* ===== CONFIG (robust deviceId without reset link) ===== */
function normSpaces(s){return (s||'').replace(/\+/g,' ').trim();}
function getParamAny(keys){
  const u = new URL(location.href);
  for (const k of keys){ const v = u.searchParams.get(k); if (v) return normSpaces(v); }
  if (u.hash && u.hash.includes('=')){
    const h = new URLSearchParams(u.hash.replace(/^#/, ''));
    for (const k of keys){ const v = h.get(k); if (v) return normSpaces(v); }
  }
  return '';
}
function getDeviceId(){
  const keys = ['deviceId','deviceid','did','DeviceId','DEVICEID'];
  let v = getParamAny(keys);
  if (v) { localStorage.setItem('cl_deviceId', v); return v; }
  v = localStorage.getItem('cl_deviceId') || '';
  if (v) return v;
  v = (prompt('Enter device ID (e.g. A9-Front-01)') || '').trim();  // one-time prompt if missing
  if (v) localStorage.setItem('cl_deviceId', v);
  return v;
}
function getParam(k){ const u=new URL(location.href); return normSpaces(u.searchParams.get(k)); }

const CFG = {
  apiUrl: "https://script.google.com/macros/s/AKfycbyYVfQcHkc95Il56206INYeOofXNlbUOwk2J0Jmj2J1oeCd_yLY1tnbM_4bdblfhdU/exec",      // <<< your Apps Script /exec
  token:  "CHANGE_ME_SUPER_SECRET",        // <<< must match SHARED_TOKEN
  storeId:     getParam('store')    || 'CL-Witbank-Highveld',
  deviceLabel: getParam('device')   || 'Front Counter',
  deviceId:    getDeviceId()
};

/* ===== QUESTIONS ===== */
const QUESTIONS = [
  { id:'Q1', text:'Speed of service' },
  { id:'Q2', text:'Friendliness of staff' },
  { id:'Q3', text:'Order accuracy' },
  { id:'Q4', text:'Cleanliness of store' },
  { id:'Q5', text:'Overall experience' }
];
const CHOICES = [
  { txt:'Excellent', score:5, emo:'ðŸ˜„' },
  { txt:'Good',      score:4, emo:'ðŸ™‚' },
  { txt:'Average',   score:3, emo:'ðŸ˜' },
  { txt:'Poor',      score:2, emo:'ðŸ™' },
  { txt:'Bad',       score:1, emo:'ðŸ˜¡' }
];

/* ===== RENDER ===== */
function makeQuestion(q){
  const card = document.createElement('div'); card.className='card';
  const title = document.createElement('div'); title.className='q-title'; title.textContent=q.text;
  const row = document.createElement('div'); row.className='q-row'; row.dataset.qid=q.id;

  CHOICES.forEach(c=>{
    const d = document.createElement('div');
    d.className='opt'; d.dataset.score=c.score;
    d.innerHTML = `<div class="emo">${c.emo}</div><div class="lbl">${c.txt}</div>`;
    d.addEventListener('click', ()=>{
      row.querySelectorAll('.opt').forEach(x=>x.classList.remove('active'));
      d.classList.add('active'); updateSubmitState();
    });
    row.appendChild(d);
  });

  card.appendChild(title); card.appendChild(row);
  return card;
}
function render(){
  const list = document.getElementById('qList');
  list.innerHTML = '';
  QUESTIONS.forEach(q => list.appendChild(makeQuestion(q)));
  document.getElementById('storeTag').textContent = `${CFG.storeId} â€¢ ${CFG.deviceLabel} â€¢ ${CFG.deviceId || 'no deviceId'}`;
}
render();

/* ===== VALIDATION ===== */
function val(id){ return (document.getElementById(id).value || '').trim(); }
function detailsAnyFilled(){ return !!(val('name') || val('surname') || val('phone') || val('email') || val('feedback')); }
function allAnswered(){ return QUESTIONS.every(q => document.querySelector(`.q-row[data-qid="${q.id}"] .opt.active`)); }
function markError(id, on){ const el=document.getElementById(id); if (el) el.classList.toggle('error', !!on); }

function updateSubmitState(){
  let ok = allAnswered();

  const any = detailsAnyFilled();
  const requireName    = any && !val('name');
  const requireSurname = any && !val('surname');
  const phoneVal       = val('phone');
  const requirePhone   = any && !/^\d{10}$/.test(phoneVal);
  const requirePOPIA   = any && !document.getElementById('popia').checked;

  const em = val('email');
  const badEmail = em && !/.+@.+\..+/.test(em);

  markError('name',    requireName);
  markError('surname', requireSurname);
  markError('phone',   requirePhone);

  if (requireName || requireSurname || requirePhone || requirePOPIA || badEmail) ok = false;
  document.getElementById('submitBtn').disabled = !ok;
}
document.addEventListener('input', updateSubmitState);

/* ===== SUBMIT ===== */
document.getElementById('submitBtn').addEventListener('click', async ()=>{
  if (!allAnswered()) { toast('Please answer all questions'); return; }

  const any = detailsAnyFilled();
  if (any){
    if (!val('name'))    { toast('Please enter your Name'); return; }
    if (!val('surname')) { toast('Please enter your Surname'); return; }
    const ph = val('phone'); if (!/^\d{10}$/.test(ph)) { toast('Please enter a valid 10-digit Phone'); return; }
    if (!document.getElementById('popia').checked){ toast('Tick POPIA consent when providing personal details'); return; }
  }
  const em = val('email'); if (em && !/.+@.+\..+/.test(em)) { toast('Enter a valid Email'); return; }

  const answers = QUESTIONS.map(q=>{
    const el = document.querySelector(`.q-row[data-qid="${q.id}"] .opt.active`);
    const score = Number(el.dataset.score);
    const ch = CHOICES.find(c=>c.score===score);
    return { questionId: q.text, choiceText: ch.txt, choiceScore: score };
  });

  const payload = {
    token: CFG.token,
    clientId: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
    storeId: CFG.storeId,
    deviceLabel: CFG.deviceLabel,
    deviceId: CFG.deviceId,
    pressedAtUtc: new Date().toISOString(),
    answers,
    marketingConsent: document.getElementById('mk').checked === true,
    customer: {
      name: val('name'),
      surname: val('surname'),
      phone: val('phone'),
      email: val('email'),
      feedback: val('feedback'),
      consent: document.getElementById('popia').checked || null
    }
  };

  try{
    await fetch(CFG.apiUrl, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(payload),
      keepalive: true
    });
    showThanks();
  }catch(err){ console.error(err); toast('Network error'); }
});

function showThanks(){
  document.getElementById('thanks').style.display='grid';
}
document.getElementById('againBtn').addEventListener('click', ()=>{
  document.getElementById('thanks').style.display='none';
  document.querySelectorAll('.opt').forEach(x=>x.classList.remove('active'));
  ['name','surname','phone','email','feedback'].forEach(id => document.getElementById(id).value='');
  document.getElementById('popia').checked = false;
  document.getElementById('mk').checked = false;
  updateSubmitState();
});
function toast(msg){ const s=document.getElementById('statusTxt'); if(!s) return; s.textContent=msg; clearTimeout(s._t); s._t=setTimeout(()=>s.textContent='',2500); }
</script>
</body>
</html>

