<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chicken Licken Feedback v2</title>
<style>
  :root{
    --green:#16a34a;--green2:#22c55e;--yellow:#facc15;
    --orange:#fb923c;--red:#dc2626;--orangeCL:#ff6900;
  }
  body{margin:0;font-family:Arial,sans-serif;background:url('./background.jpg')center/cover no-repeat fixed;}
  .container{background:rgba(255,255,255,.94);max-width:820px;margin:2%auto;padding:18px;border-radius:18px;}
  h1{color:#1a1a1a;margin:0 0 10px;font-weight:900;text-align:center;}
  .question{margin:10px 0;}
  .q-title{font-weight:700;margin-bottom:8px;}
  .q-row{display:flex;flex-wrap:wrap;gap:6px;justify-content:space-between;}
  .opt{
    flex:1 1 18%;min-width:110px;
    text-align:center;padding:10px;border-radius:12px;
    color:#fff;font-weight:700;cursor:pointer;user-select:none;
    border:2px solid transparent;transition:.1s;
  }
  .opt.active{border:3px solid #000;}
  .opt[data-score="5"]{background:var(--green);}
  .opt[data-score="4"]{background:var(--green2);}
  .opt[data-score="3"]{background:var(--yellow);color:#000;}
  .opt[data-score="2"]{background:var(--orange);}
  .opt[data-score="1"]{background:var(--red);}
  input,textarea{width:100%;padding:9px;border-radius:10px;border:1.4px solid #ddd;font-size:15px;}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  @media(max-width:680px){.grid2{grid-template-columns:1fr}}
  .btn{background:var(--orangeCL);color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:900;font-size:17px;cursor:pointer;}
  .btn:disabled{opacity:.6;cursor:not-allowed;}
  small{color:#555;}
  .thanks{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);place-items:center;}
  .thanks .in{background:#fff;padding:22px;border-radius:16px;text-align:center;width:min(420px,90vw);}
</style>
</head>
<body>
<div class="container">
  <h1>Chicken Licken Quick Feedback</h1>
  <div id="questions"></div>

  <h3>Optional Details</h3>
  <div class="grid2">
    <div><input id="name" placeholder="Name (optional)"></div>
    <div><input id="surname" placeholder="Surname (optional)"></div>
  </div>
  <div class="grid2" style="margin-top:8px;">
    <div><input id="phone" placeholder="Phone (optional, 10 digits)" maxlength="10"></div>
    <div><input id="email" placeholder="Email (optional)"></div>
  </div>
  <textarea id="feedback" placeholder="Additional feedback (optional)" style="margin-top:8px;"></textarea>
  <label style="display:flex;align-items:start;gap:8px;margin-top:8px;">
    <input type="checkbox" id="popia" style="margin-top:4px;">
    <small>I consent to the collection and processing of my personal information for customer service and quality feedback purposes in accordance with the POPIA.</small>
  </label>
  <div style="text-align:right;margin-top:10px;">
    <button class="btn" id="submitBtn" disabled>Submit</button>
  </div>
</div>

<div class="thanks" id="thanks">
  <div class="in">
    <h2>Thank you!</h2>
    <p>Your feedback has been recorded.</p>
    <button class="btn" id="doneBtn">Done</button>
  </div>
</div>

<script>
const CFG={apiUrl:"https://script.google.com/macros/s/AKfycbwybDfo0ncc1Wf0EG1ryyUi1sSXkteVSr7botwW8kr3zIp-4r14wV8sODmSgLFgRDEz/exec",token:"CHANGE_ME_SUPER_SECRET",
storeId:getParam("store")||"CL-Witbank-Highveld",deviceLabel:getParam("device")||"Front Counter"};
function getParam(k){const u=new URL(location.href);return u.searchParams.get(k);}
const QUESTIONS=[
{id:"Q1",text:"Speed of service"},
{id:"Q2",text:"Friendliness of staff"},
{id:"Q3",text:"Order accuracy"},
{id:"Q4",text:"Cleanliness of store"},
{id:"Q5",text:"Overall experience"}
];
const CHOICES=[
{txt:"Excellent",score:5,emo:"ðŸ˜„"},
{txt:"Good",score:4,emo:"ðŸ™‚"},
{txt:"Average",score:3,emo:"ðŸ˜"},
{txt:"Poor",score:2,emo:"ðŸ™"},
{txt:"Bad",score:1,emo:"ðŸ˜¡"}
];

// --- Render questions ---
function render(){
 const wrap=document.getElementById("questions");
 wrap.innerHTML="";
 QUESTIONS.forEach(q=>{
   const div=document.createElement("div");div.className="question";
   const title=document.createElement("div");title.className="q-title";title.textContent=q.text;
   const row=document.createElement("div");row.className="q-row";row.dataset.qid=q.id;
   CHOICES.forEach(c=>{
     const o=document.createElement("div");o.className="opt";o.dataset.score=c.score;
     o.innerHTML=`<div style='font-size:24px;'>${c.emo}</div><div>${c.txt}</div>`;
     o.onclick=()=>{row.querySelectorAll(".opt").forEach(x=>x.classList.remove("active"));o.classList.add("active");updateState();};
     row.appendChild(o);
   });
   div.appendChild(title);div.appendChild(row);wrap.appendChild(div);
 });
}
render();

function allAnswered(){return QUESTIONS.every(q=>document.querySelector(`.q-row[data-qid="${q.id}"] .opt.active`));}
function needsPOPIA(){
  const n=val("name")||val("surname")||val("phone")||val("email");
  return !!n;
}
function val(id){return document.getElementById(id).value.trim();}
function updateState(){
  const ok=allAnswered() && (!needsPOPIA()||document.getElementById("popia").checked);
  document.getElementById("submitBtn").disabled=!ok;
}

document.addEventListener("input",updateState);

document.getElementById("submitBtn").onclick=async()=>{
  if(!allAnswered()){alert("Please answer all questions.");return;}
  if(needsPOPIA()&&!document.getElementById("popia").checked){alert("Tick POPIA consent if you provide personal details.");return;}

  const phone=val("phone");
  if(phone && (!/^\d{10}$/.test(phone))){alert("Please enter a valid 10-digit phone number.");return;}

  const email=val("email");
  if(email && (!/.+@.+\..+/.test(email))){alert("Please enter a valid email address.");return;}

  const answers=QUESTIONS.map(q=>{
    const a=document.querySelector(`.q-row[data-qid="${q.id}"] .opt.active`);
    const score=Number(a.dataset.score);
    const choice=CHOICES.find(c=>c.score===score);
    return{questionId:q.text,choiceText:choice.txt,choiceScore:score};
  });

  const payload={
    token:CFG.token,clientId:`${Date.now()}-${Math.random().toString(16).slice(2)}`,
    storeId:CFG.storeId,deviceLabel:CFG.deviceLabel,deviceId:"",
    pressedAtUtc:new Date().toISOString(),answers,
    customer:{
      name:val("name"),surname:val("surname"),phone,email,
      feedback:val("feedback"),consent:document.getElementById("popia").checked||null
    }
  };

  try{
    await fetch(CFG.apiUrl,{method:"POST",mode:"no-cors",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body:JSON.stringify(payload),keepalive:true});
    document.getElementById("thanks").style.display="grid";
  }catch(e){alert("Network error.");}
};

document.getElementById("doneBtn").onclick=()=>{
  document.getElementById("thanks").style.display="none";
  document.querySelectorAll(".opt").forEach(o=>o.classList.remove("active"));
  ["name","surname","phone","email","feedback"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("popia").checked=false;
  updateState();
};
</script>
</body>
</html>
