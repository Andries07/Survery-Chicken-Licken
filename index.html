<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chicken Licken â€¢ Quick Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light" />
  <style>
    :root{
      --orange:#ff6900; --green:#2db355; --yellow:#f7c948; --red:#e64b3c; --grey:#e9ecef; --ink:#111; --ink-2:#333;
      --bg:#faf6f2;
      --card-bg: rgba(255,255,255,0.90);
      --btn-h: 56px;  /* button height */
      --gap: 12px;
      --radius: 14px;
      --maxw: 760px;  /* good for 8.7" portrait */
    }
    *{ box-sizing:border-box; touch-action:manipulation; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink); background:var(--bg);
      background-image:
        radial-gradient(rgba(255,105,0,.06) 1px, transparent 1px),
        radial-gradient(rgba(255,105,0,.05) 1px, transparent 1px);
      background-position: 0 0, 16px 16px;
      background-size: 32px 32px;
    }
    .wrap{
      min-height:100%;
      display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .card{
      width:100%; max-width:var(--maxw);
      background:var(--card-bg); backdrop-filter:saturate(1.1) blur(2px);
      border-radius:var(--radius); border:1px solid rgba(0,0,0,.06);
      box-shadow: 0 10px 28px rgba(0,0,0,.08);
      padding: clamp(12px, 2.5vw, 20px);
    }
    .header{
      display:flex; align-items:center; gap:12px; margin-bottom:10px;
    }
    .logo{ width:44px; height:44px; border-radius:10px; background:var(--orange); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:900; }
    .title{ font-size: clamp(18px, 4vw, 26px); font-weight:900; line-height:1.1; color:#fff;
      text-shadow: 0 1px 0 rgba(0,0,0,.35); }
    .title-wrap{
      width:100%; background:linear-gradient(90deg, var(--orange), #ff8c33);
      padding:10px 12px; border-radius:12px; margin-bottom:14px; display:flex; align-items:center; gap:10px;
    }
    .meta{ font-size:12px; color:#555; margin:6px 0 0; }
    .q{
      margin-top:14px; padding:10px; border-radius:12px; background:#fff; border:1px solid rgba(0,0,0,.06);
    }
    .q h3{
      margin:0 0 10px; font-size: clamp(15px, 3.5vw, 18px); font-weight:800; color:var(--ink-2);
    }
    .row{
      display:grid; grid-template-columns: repeat(5, 1fr); gap:10px;
    }
    .btn{
      height:var(--btn-h); border-radius:12px; border:2px solid transparent; font-weight:800; font-size: clamp(14px, 3.5vw, 16px);
      display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer; user-select:none;
      transition: transform .05s ease, box-shadow .1s ease, border-color .15s ease;
      background:#f5f5f5; color:#111;
    }
    .btn .emo{ font-size: 1.25em; }
    .btn:hover{ border-color:#000; }
    .btn:active{ transform: translateY(1px); }
    .btn.sel{ box-shadow: 0 0 0 3px rgba(0,0,0,.10) inset; border-color:#000; }
    .btn.green{ background:#eaf7ef; }
    .btn.yellow{ background:#fff7df; }
    .btn.avg{ background:#eef1f4; }
    .btn.red{ background:#fdebea; }
    .btn.good{ background:#e9f7ff; }

    .opt{
      margin-top:14px; padding:12px; border-radius:12px; background:#fff; border:1px solid rgba(0,0,0,.06);
    }
    .opt h4{ margin:0 0 10px; font-size: clamp(14px, 3.2vw, 16px); font-weight:900; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid1{ display:grid; grid-template-columns:1fr; gap:10px; }
    label{ font-size:12px; color:#444; font-weight:700; display:block; margin-bottom:6px;}
    input, textarea{
      width:100%; padding:12px 12px; border-radius:10px; border:1px solid #d9dde3; font-size:16px;
      background:#fbfbfc;
    }
    textarea{ min-height: 96px; resize: none; }
    .checks{ margin-top:6px; display:grid; gap:8px; }
    .ck{ display:flex; align-items:flex-start; gap:8px; }
    .ck input{ width:20px; height:20px; margin-top:2px; }
    .ck span{ font-size:12px; color:#333; line-height:1.35; }
    .actions{
      display:flex; align-items:center; gap:10px; margin-top:14px;
    }
    .submit{
      appearance:none; border:none; border-radius:12px; background:#111; color:#fff; font-weight:900;
      padding:14px 18px; font-size: clamp(16px, 3.8vw, 18px); cursor:pointer;
      flex: 1 1 auto;
    }
    .submit.is-disabled{ opacity:.6; pointer-events:none; }
    .note{ font-size:12px; color:#666; }

    /* Thank-you overlay */
    .ty{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; z-index:99;
    }
    .ty .inner{
      width:min(88vw, 560px); background:#fff; border-radius:16px; padding:22px; text-align:center;
      border:1px solid rgba(255,255,255,.6);
    }
    .ty h2{ margin:0 0 8px; font-size: clamp(18px, 4.5vw, 24px); font-weight:900; }
    .ty p{ margin:0; color:#444; }
    .store-pill{
      display:inline-block; font-size:12px; background:#ffe7d6; color:#111; padding:4px 8px; border-radius:999px; margin-left:6px;
      border:1px solid rgba(0,0,0,.05);
    }

    /* Responsive */
    @media (max-width:520px){
      :root{ --btn-h: 52px; --maxw: 640px; }
      .grid2{ grid-template-columns:1fr; }
      .row{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title-wrap">
        <div class="logo">CL</div>
        <div class="title">Chicken Licken â€¢ Quick Feedback</div>
      </div>
      <div class="meta" id="metaLine">Store: â€” â€¢ Device: â€”</div>

      <!-- Questions -->
      <div id="qs"></div>

      <!-- Optional details -->
      <div class="opt" id="optBox">
        <h4>Optional details (helps us contact you)</h4>
        <div class="grid2">
          <div>
            <label for="name">Name (max 50)</label>
            <input id="name" maxlength="50" autocomplete="given-name" />
          </div>
          <div>
            <label for="surname">Surname (max 50)</label>
            <input id="surname" maxlength="50" autocomplete="family-name" />
          </div>
        </div>
        <div class="grid2">
          <div>
            <label for="phone">Phone (10 digits)</label>
            <input id="phone" inputmode="numeric" pattern="[0-9]{10}" maxlength="10" autocomplete="tel" />
          </div>
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" inputmode="email" autocomplete="email" />
          </div>
        </div>
        <div class="grid1">
          <div>
            <label for="feedback">Additional feedback (max 3000)</label>
            <textarea id="feedback" maxlength="3000" placeholder="Tell us what went well, or what we can improveâ€¦"></textarea>
          </div>
        </div>
        <div class="checks">
          <label class="ck">
            <input id="popia" type="checkbox" />
            <span>
              I understand and consent per the POPIA. If I provide my details, I agree that they may be used to contact me about this feedback. I also accept that anonymised data may be used to improve service quality.
            </span>
          </label>
          <label class="ck">
            <input id="mk" type="checkbox" />
            <span>
              I agree to receive marketing news and promotions from Chicken Licken for this store. I can opt out at any time.
            </span>
          </label>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button id="submitBtn" class="submit">Submit</button>
        <div class="note">Takes a few seconds â€” please wait for the thank-you.</div>
      </div>
    </div>
  </div>

  <!-- Thank-you -->
  <div class="ty" id="thankyou">
    <div class="inner">
      <h2>Thank you! ðŸ™Œ</h2>
      <p>Your feedback helps us serve you better.<span id="tyStore" class="store-pill"></span></p>
    </div>
  </div>

  <script>
  /* ===================== CONFIG ===================== */
  const CFG = {
    apiUrl: 'https://script.google.com/macros/s/AKfycbza89rJkHgT5uxvFnixlxjoyNkdU6zu6dxg7zVAXNzvyRy94BABknWocL9TnvcBRnU/exec', // <-- paste your Apps Script Web App URL (/exec)
    token:  'CHANGE_ME_SUPER_SECRET',                                           // <-- must match Apps Script
    // Defaults (can be overridden by URL params)
    storeId:     'CL-Witbank-Highveld',
    deviceLabel: 'Front Counter',
    deviceId:    'A9-QR',
    THANKYOU_MS: 3000  // how long the thank-you overlay shows
  };

  /* ===================== UTILITIES ===================== */
  function qs(p){ return new URLSearchParams(location.search).get(p) || ''; }
  function applyUrlDefaults(){
    const s = qs('store');      if (s) CFG.storeId = s;
    const d = qs('device');     if (d) CFG.deviceLabel = d.replaceAll('+',' ');
    const did= qs('deviceId');  if (did) CFG.deviceId = did;
    const v = document.getElementById('metaLine');
    if (v) v.textContent = `Store: ${CFG.storeId} â€¢ Device: ${CFG.deviceLabel}`;
    const ty = document.getElementById('tyStore');
    if (ty) ty.textContent = ` ${CFG.storeId}`;
  }
  function val(id){ const el=document.getElementById(id); return el?el.value.trim():''; }

  // per-device anonymous ID (for server 24h rule)
  function getOrMakeAnonId(){
    let id = localStorage.getItem('cl_anon_id');
    if (!id){ id = 'a9_' + Math.random().toString(36).slice(2,14); localStorage.setItem('cl_anon_id', id); }
    return id;
  }
  const ANON_ID = getOrMakeAnonId();

  /* ===================== QUESTIONS ===================== */
  const QUESTIONS = [
    { id:'Q1', text:'How was the speed of service?' },
    { id:'Q2', text:'How friendly & helpful were our staff?' },
    { id:'Q3', text:'How was your order accuracy?' },
    { id:'Q4', text:'How clean was the store?' },
    { id:'Q5', text:'Overall, how was your experience?' }
  ];
  const CHOICES = [
    { label:'Poor',      score:1, cls:'red',    emo:'ðŸ˜¡' },
    { label:'Bad',       score:2, cls:'red',    emo:'ðŸ˜ ' },
    { label:'Average',   score:3, cls:'avg',    emo:'ðŸ˜' },
    { label:'Good',      score:4, cls:'green',  emo:'ðŸ™‚' },
    { label:'Excellent', score:5, cls:'green',  emo:'ðŸ¤©' }
  ];

  function renderQuestions(){
    const host = document.getElementById('qs');
    host.innerHTML = '';
    QUESTIONS.forEach(q=>{
      const sec = document.createElement('div');
      sec.className = 'q';
      const h = document.createElement('h3');
      h.textContent = q.text;
      sec.appendChild(h);

      const row = document.createElement('div');
      row.className = 'row';
      CHOICES.forEach(ch=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = `btn ${ch.cls}`;
        b.dataset.qid = q.id;
        b.dataset.label = ch.label;
        b.dataset.score = String(ch.score);
        b.innerHTML = `<span class="emo">${ch.emo}</span> ${ch.label}`;
        b.addEventListener('click', ()=>selectChoice(q.id, b));
        row.appendChild(b);
      });
      sec.appendChild(row);
      host.appendChild(sec);
    });
  }

  function selectChoice(qid, btn){
    // unselect siblings
    const siblings = btn.parentElement.querySelectorAll('.btn');
    siblings.forEach(x=>x.classList.remove('sel'));
    btn.classList.add('sel');
  }

  function buildAnswers(){
    return QUESTIONS.map(q=>{
      const chosen = document.querySelector(`.q .row .btn.sel[data-qid="${q.id}"]`);
      if (!chosen) throw new Error('Please answer all questions before submitting.');
      return {
        questionId: q.id,
        choiceText: chosen.dataset.label,
        choiceScore: Number(chosen.dataset.score)
      };
    });
  }

  function resetSurvey(){
    // clear selections & inputs (ready for next customer)
    document.querySelectorAll('.btn.sel').forEach(b=>b.classList.remove('sel'));
    ['name','surname','phone','email','feedback'].forEach(id=>{
      const el = document.getElementById(id); if (el) el.value = '';
    });
    ['popia','mk'].forEach(id=>{
      const el = document.getElementById(id); if (el) el.checked = false;
    });
  }

  /* ===================== THANK-YOU / SUBMIT ===================== */
  let SUBMITTING = false;
  function lockUI(){
    const btn = document.getElementById('submitBtn');
    if (btn){ btn.disabled = true; btn.classList.add('is-disabled'); }
  }
  function unlockUI(){
    const btn = document.getElementById('submitBtn');
    if (btn){ btn.disabled = false; btn.classList.remove('is-disabled'); }
  }
  function showThankYou(){ const el=document.getElementById('thankyou'); if (el) el.style.display='flex'; }
  function hideThankYou(){ const el=document.getElementById('thankyou'); if (el) el.style.display='none'; }
  function newClientId(){ return `${Date.now()}-${Math.random().toString(16).slice(2)}`; }

  async function submitSurvey(){
    if (SUBMITTING) return;
    SUBMITTING = true; lockUI();

    let answers;
    try{
      answers = buildAnswers();
    }catch(e){
      SUBMITTING = false; unlockUI();
      alert(e.message || 'Please answer all questions.'); return;
    }

    // OPTIONAL field validation
    const email = val('email'); const phone = val('phone');
    if (email && !/.+@.+\..+/.test(email)){ SUBMITTING=false; unlockUI(); alert('Please enter a valid email.'); return; }
    if (phone && !/^\d{10}$/.test(phone)){ SUBMITTING=false; unlockUI(); alert('Phone must be 10 digits.'); return; }

    const payload = {
      token: CFG.token,
      clientId: newClientId(),                               // server debounces duplicates for 5 minutes
      storeId: CFG.storeId,
      deviceLabel: CFG.deviceLabel,
      deviceId: CFG.deviceId,
      pressedAtUtc: new Date().toISOString(),                // server stores SAST for PressedAt
      answers,
      marketingConsent: document.getElementById('mk')?.checked === true,
      customer: {
        name: val('name'), surname: val('surname'), phone, email,
        feedback: val('feedback'),
        consent: document.getElementById('popia')?.checked || null
      },
      anonId: ANON_ID                                        // for 24h per-store limit (server)
    };

    // INSTANT THANK-YOU to stop spamming
    showThankYou();

    try{
      const r = await fetch(CFG.apiUrl, {
        method:'POST',
        headers:{'Content-Type':'text/plain; charset=utf-8'},
        body: JSON.stringify(payload)
      });
      // Even if JSON fails, user experience is already good (TY shown immediately)
      const j = await r.json().catch(()=>({ok:false}));
      // Optionally, you could log j to console for debugging:
      // console.log('server:', j);
    }catch(err){
      // Network error; we still showed TY to avoid spam. You can optionally show a subtle toast/log.
      // console.error(err);
    }finally{
      setTimeout(()=>{
        hideThankYou(); SUBMITTING=false; unlockUI(); resetSurvey();
        // Optionally reload to ensure a fresh state:
        // location.reload();
      }, CFG.THANKYOU_MS);
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    applyUrlDefaults();
    renderQuestions();
    document.getElementById('submitBtn').addEventListener('click', submitSurvey, {passive:true});
  });
  </script>
</body>
</html>
