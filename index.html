<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Chicken Licken Feedback</title>

<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="./icon-512.png">

<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#ff6a00;
    --text:#111;
    --white: #fff;
    --card-rgba: rgba(255,255,255,.9);
    --shadow: 0 3px 10px rgba(0,0,0,.16), 0 12px 28px rgba(0,0,0,.18);
    --green: #3ecf8e; --green2:#a5e5c3;
    --yellow:#ffe365; --orange:#ff9f3c; --red:#ff5757;
  }
  html,body{height:100%}
  body{
    margin:0;
    font:15px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
    color:var(--text);
    background:#000;
  }
  .hero{
    min-height:100%;
    background:
      linear-gradient( to bottom, rgba(0,0,0,.35), rgba(0,0,0,.4)),
      url('./img/Final Image Background Orange.jpg');
    background-repeat:repeat;background-size:128px auto;background-position:top left;
    display:grid;place-items:start center;padding:8px 2vw 10px;
  }
  .wrap{
    width:min(760px,96vw);height:100%;
    display:grid;grid-template-rows:auto 1fr auto;gap:6px;
  }
  h1{
    margin:0;text-align:center;color:#fff;font-weight:900;font-size:20px;line-height:1.1;
    text-shadow:0 2px 8px rgba(0,0,0,.55);
  }

  .content{min-height:0;overflow:hidden;display:grid;grid-template-rows:auto auto;gap:6px}
  .grid{display:grid;gap:6px}
  .card{background:var(--card-rgba);border-radius:10px;padding:8px;box-shadow:var(--shadow);-webkit-backdrop-filter:saturate(120%) blur(2px);backdrop-filter:saturate(120%) blur(2px)}
  .q-title{font-weight:900;font-size:15px;line-height:1.2;margin-bottom:4px;color:var(--text);letter-spacing:.2px}

  .q-row{display:grid;grid-template-columns:repeat(5,1fr);gap:5px}
  .opt{display:grid;place-items:center;gap:2px;padding:7px;min-height:66px;color:#fff;border-radius:10px;font-weight:800;font-size:14px;cursor:pointer;border:2px solid transparent;user-select:none}
  .opt.active{outline:3px solid #000}
  .opt[data-score="5"]{background:var(--green)}
  .opt[data-score="4"]{background:var(--green2)}
  .opt[data-score="3"]{background:var(--yellow);color:#111}
  .opt[data-score="2"]{background:var(--orange)}
  .opt[data-score="1"]{background:var(--red)}
  .emo{font-size:17px}
  .lbl{font-size:11px}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  @media (max-width:640px){.grid2{grid-template-columns:1fr}}

  label{font-size:12px;font-weight:700;display:block;margin:2px 0 4px 2px}
  input[type="text"], input[type="email"], textarea{
    width:100%;border:2px solid #ddd;border-radius:10px;padding:9px 10px;font:14px/1.3 inherit
  }
  textarea{min-height:80px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .tiny{font-size:12px;opacity:.8}
  .err{outline:3px solid #ff5757}

  .footer{display:grid;grid-template-columns:1fr auto;align-items:center;color:#fff}
  .btn{background:#000;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:900;font-size:14px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.25)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:#ffffff;opacity:.9;font-size:12px;min-height:16px;text-shadow:0 1px 3px rgba(0,0,0,.6)}

  .thanks{display:none;position:fixed;inset:0;z-index:20;place-items:center}
  .thanks::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.66);backdrop-filter: blur(2px)}
  .thanks::after{content:"";position:absolute;inset:0;background:
    url('./img/Final Image Background Orange.jpg');
    background-repeat:repeat;background-size:128px auto;opacity:.85}
  .thanks .in{position:relative;background:#fff;padding:14px;border-radius:12px;text-align:center;font-weight:900;width:min(320px,92vw);box-shadow:0 18px 54px rgba(0,0,0,.4)}
</style>
</head>
<body>
<script>
  if('serviceWorker' in navigator){navigator.serviceWorker.getRegistrations().then(r=>r.forEach(x=>x.unregister()));}
  if('caches' in window){caches.keys().then(k=>k.forEach(c=>caches.delete(c)));}

  (function(){const POLL=10*60*1000;function check(){fetch('./version.json?ts='+Date.now()).then(r=>r.json()).then(v=>{const cur=localStorage.getItem('appVersion');localStorage.setItem('appVersion',v.version);if(cur&&cur!==v.version)location.reload(true);}).catch(()=>{});}try{check();setInterval(check,POLL);}catch(e){}})();
</script>

<div class="hero">
  <div class="wrap">
    <h1>Chicken Licken Quick Feedback</h1>

    <div class="content">
      <!-- QUESTIONS -->
      <div id="qList" class="grid"></div>

      <!-- OPTIONAL DETAILS (always visible) -->
      <div class="card">
        <h3 class="q-title" style="margin:0 0 4px">Optional details</h3>
        <div class="tiny">If you add details, <b>Name</b>, <b>Surname</b>, and a valid <b>10-digit Phone</b> are required and you must accept POPIA.</div>
        <div class="grid2" style="margin-top:6px">
          <div>
            <label for="name">Name</label>
            <input id="name" type="text" placeholder="e.g. Thabo">
          </div>
          <div>
            <label for="surname">Surname</label>
            <input id="surname" type="text" placeholder="e.g. Mokoena">
          </div>
          <div>
            <label for="phone">Phone (10 digits)</label>
            <input id="phone" type="text" inputmode="numeric" pattern="\d*" maxlength="10" placeholder="e.g. 0821234567">
          </div>
          <div>
            <label for="email">Email (optional)</label>
            <input id="email" type="email" placeholder="e.g. you@example.com">
          </div>
          <div style="grid-column:1/-1">
            <label for="feedback">Anything we should know?</label>
            <textarea id="feedback" placeholder="Tell us what happened (optional)"></textarea>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
          <label class="tiny" style="display:flex;align-items:center;gap:8px;margin:0">
            <input id="popia" type="checkbox"> I consent to the processing of my personal information (POPIA)
          </label>
          <label class="tiny" style="display:flex;align-items:center;gap:8px;margin:0 0 0 auto">
            <input id="mk" type="checkbox"> OK to receive specials (optional)
          </label>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="muted" id="statusTxt"></div>
      <button id="submitBtn" class="btn" disabled>Submit feedback</button>
    </div>
  </div>
</div>

<div class="thanks" id="thanks">
  <div class="in">
    <div style="font-size:28px;margin:8px 0 6px">Thank you! 🙌</div>
    <div style="font-weight:700;color:#111">Your feedback helps us serve you better.</div>
  </div>
</div>

<script>
/* ===== UTILS ===== */
function getParam(k){const u=new URL(location.href);return u.searchParams.get(k);}
function markError(id,yes){const el=document.getElementById(id);if(!el)return;el.classList.toggle('err',!!yes);}
function val(id){const el=document.getElementById(id);return el?el.value.trim():'';}
function allAnswered(){return [...document.querySelectorAll('.q-row')].every(row=>row.querySelector('.opt.active'))}
function detailsAnyFilled(){return ['name','surname','phone','email','feedback'].some(id=>val(id))}

/* ===== DEVICE ID (stable per browser) ===== */
function getDeviceId(){
  let v=localStorage.getItem('cl_deviceId')||'';if(v)return v;v=(prompt('Enter a Device ID or label for this tablet (e.g. FRONT-COUNTER).','')||'').trim();if(v)localStorage.setItem('cl_deviceId',v);return v;
}

/* ===== CONFIG (SET THESE) ===== */
const CFG = {
  apiUrl: "https://script.google.com/macros/s/AKfycbwDOaS2wGj_IOH5b6VmvmwnCeRKIysWjavoceMGJAPRufLtC9I1V0qX0mF1_-4b2ruo/exec",  // Apps Script /exec
  token:  "CHANGE_ME_SUPER_SECRET",        // must match SHARED_TOKEN
  storeId:     getParam('store')  || 'CL-Witbank-Highveld',
  deviceLabel: getParam('device') || 'Front Counter',
  deviceId:    getDeviceId()
};

/* ===== INSTANT SUBMIT WRAPPER & IDEMPOTENCY ===== */
let CL_BLOCKING=false;
function uuid(){
  try{ return crypto.randomUUID(); }catch(e){
    return 'sub-'+Date.now()+'-'+Math.random().toString(16).slice(2);
  }
}
const MIN_THANKYOU_MS = 3000;

async function sendJSON(url, payload){
  try{
    await fetch(url, {
      method:'POST',
      headers: { 'Content-Type': 'application/json', 'X-CL-Token': CFG.token },
      body: JSON.stringify(payload),
      keepalive: true,
      cache: 'no-store',
      mode: 'cors',
      redirect: 'follow'
    });
    return true;
  }catch(e){ return false; }
}

async function sendPlain(url, payload){
  try{
    await fetch(url, {
      method:'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8', 'X-CL-Token': CFG.token },
      body: JSON.stringify(payload),
      keepalive: true,
      mode: 'no-cors'
    });
    return true;
  }catch(e){ return false; }
}

function sendBeacon(url, payload){
  try{
    const blob = new Blob([JSON.stringify(payload)], {type:'text/plain;charset=utf-8'});
    navigator.sendBeacon(url, blob);
    return true;
  }catch(e){ return false; }
}

async function CL_SUBMIT_SURVEY(payload){
  if (CL_BLOCKING) return;
  CL_BLOCKING = true;

  // Add ids + timestamps
  payload.submissionId = uuid();
  payload.pressedAtUtc = new Date().toISOString();

  const started = Date.now();
  showThanks(); // instant UX

  // try JSON first, then plain/no-cors, then beacon
  let ok = await sendJSON(CFG.apiUrl, payload);
  if (!ok) ok = await sendPlain(CFG.apiUrl, payload);
  if (!ok) ok = sendBeacon(CFG.apiUrl, payload);

  // local 24h guard marking (by phone/email) regardless of network ok
  dupLocalMark();

  const elapsed = Date.now() - started;
  const wait = Math.max(0, MIN_THANKYOU_MS - elapsed);
  setTimeout(()=>{ CL_BLOCKING=false; resetForm(); }, wait);
}

/* ===== QUESTIONS ===== */
const QUESTIONS=[
  {id:'Q1',text:'Speed of service'},
  {id:'Q2',text:'Friendliness of staff'},
  {id:'Q3',text:'Order accuracy'},
  {id:'Q4',text:'Cleanliness of store'},
  {id:'Q5',text:'Overall experience'}
];
const CHOICES=[
  {txt:'Excellent',score:5,emo:'😄'},
  {txt:'Good',     score:4,emo:'🙂'},
  {txt:'Average',  score:3,emo:'😐'},
  {txt:'Poor',     score:2,emo:'🙁'},
  {txt:'Bad',      score:1,emo:'😡'}
];

/* ===== RENDER ===== */
function makeQuestion(q){
  const card=document.createElement('div');card.className='card';
  const title=document.createElement('div');title.className='q-title';title.textContent=q.text;
  const row=document.createElement('div');row.className='q-row';row.dataset.qid=q.id;
  CHOICES.forEach(c=>{
    const d=document.createElement('div');
    d.className='opt';d.dataset.score=c.score;
    d.innerHTML=`<div class="emo">${c.emo}</div><div class="lbl">${c.txt}</div>`;
    d.addEventListener('click',()=>{
      row.querySelectorAll('.opt').forEach(x=>x.classList.remove('active'));
      d.classList.add('active');updateSubmitState();
    });
    row.appendChild(d);
  });
  card.appendChild(title);card.appendChild(row);
  return card;
}
document.getElementById('qList').append(...QUESTIONS.map(makeQuestion));

/* ===== VALIDATION ===== */
function updateSubmitState(){
  let ok=allAnswered();
  const any=detailsAnyFilled();
  const requireName=any&&!val('name');
  const requireSurname=any&&!val('surname');
  const phoneVal=val('phone');
  const requirePhone=any&&!/^\d{10}$/.test(phoneVal);
  const requirePOPIA=any&&!document.getElementById('popia').checked;
  const em=val('email');
  const badEmail=em&&!/.+@.+\..+/.test(em);
  markError('name',requireName);markError('surname',requireSurname);markError('phone',requirePhone);
  if(requireName||requireSurname||requirePhone||requirePOPIA||badEmail)ok=false;
  document.getElementById('submitBtn').disabled=!ok;
}
document.addEventListener('input',updateSubmitState);

/* ===== LIGHT CLIENT DUP GUARD (local) ===== */
function within24h(ts){return (Date.now() - Number(ts)) < 24*60*60*1000;}
function dupLocalBlockIfAny(){
  const phone=val('phone'); const email=(val('email')||'').toLowerCase();
  if(!phone && !email) return false;
  const kP = phone ? `cl_last_phone_${phone}` : null;
  const kE = email ? `cl_last_email_${email}` : null;
  if(kP && localStorage.getItem(kP) && within24h(localStorage.getItem(kP))) return true;
  if(kE && localStorage.getItem(kE) && within24h(localStorage.getItem(kE))) return true;
  return false;
}
function dupLocalMark(){
  const phone=val('phone'); const email=(val('email')||'').toLowerCase();
  if(phone) localStorage.setItem(`cl_last_phone_${phone}`, String(Date.now()));
  if(email) localStorage.setItem(`cl_last_email_${email}`, String(Date.now()));
}

/* ===== SUBMIT ===== */
document.getElementById('submitBtn').addEventListener('click',()=>{
  if (CL_BLOCKING) return;
  if(!allAnswered()){toast('Please answer all questions');return;}
  const any=detailsAnyFilled();
  if(any){
    if(!val('name')){toast('Please enter your Name');return;}
    if(!val('surname')){toast('Please enter your Surname');return;}
    const ph=val('phone');if(!/^\d{10}$/.test(ph)){toast('Enter a valid 10-digit Phone');return;}
    if(!document.getElementById('popia').checked){toast('Tick POPIA consent');return;}
  }
  const em=val('email');if(em&&!/.+@.+\..+/.test(em)){toast('Enter a valid Email');return;}
  if(dupLocalBlockIfAny()){ toast('You have already submitted in the last 24 hours.'); return; }

  const answers=QUESTIONS.map(q=>{
    const el=document.querySelector(`.q-row[data-qid="${q.id}"] .opt.active`);
    const score=Number(el.dataset.score);
    const ch=CHOICES.find(c=>c.score===score);
    return{questionId:q.text,choiceText:ch.txt,choiceScore:score};
  });

  const payload={
    token:CFG.token,
    clientId:`${Date.now()}-${Math.random().toString(16).slice(2)}`,
    storeId:CFG.storeId,deviceLabel:CFG.deviceLabel,deviceId:CFG.deviceId,
    // pressedAtUtc is added in CL_SUBMIT_SURVEY
    answers,
    marketingConsent:document.getElementById('mk').checked===true,
    customer:{
      name:val('name'),surname:val('surname'),phone:val('phone'),
      email:val('email'),feedback:val('feedback'),
      consent:document.getElementById('popia').checked||null
    }
  };

  CL_SUBMIT_SURVEY(payload);
});
function showThanks(){
  const el=document.getElementById('thanks');
  el.style.display='grid';
  clearTimeout(el._t);
  el._t=setTimeout(()=>{ el.style.display='none'; resetForm(); }, 2500);
}
function resetForm(){
  document.querySelectorAll('.opt').forEach(x=>x.classList.remove('active'));
  ['name','surname','phone','email','feedback'].forEach(id=>{const e=document.getElementById(id); if(e) e.value='';});
  document.getElementById('popia').checked=false;
  document.getElementById('mk').checked=false;
  updateSubmitState();
}
function toast(msg){const s=document.getElementById('statusTxt');s.textContent=msg;clearTimeout(s._t);s._t=setTimeout(()=>s.textContent='',1600);}
</script>
</body>
</html>
